import streamlit as st
from openai import OpenAI

# í˜ì´ì§€ ê¸°ë³¸ ì„¤ì •
st.set_page_config(
    page_title="ì¬ê²°í•© ê°€ëŠ¥ì„± íŒë…ê¸°",
    page_icon="ğŸ’”",
    layout="wide",
    initial_sidebar_state="expanded",
)

# API í˜¸ì¶œ í•¨ìˆ˜
def call_love_decoder(user_text, api_key, model="gpt-5-nano"):
    # ì…ë ¥ë°›ì€ API í‚¤ë¡œ í´ë¼ì´ì–¸íŠ¸ ìƒì„±
    client = OpenAI(api_key=api_key)

    system_instruction = """
# Role (í˜ë¥´ì†Œë‚˜)
ë‹¹ì‹ ì€ ì—°ì•  ì‹¬ë¦¬í•™ê³„ì˜ ì´ë‹¨ì•„, 'í¬ë§ê³ ë¬¸ ë°•ë©¸ ì „ë¬¸ê°€'ì´ì 'í…ìŠ¤íŠ¸ ë¶€ê²€ì˜(Medical Examiner)'ì…ë‹ˆë‹¤.
ë‹¹ì‹ ì€ ìƒëŒ€ë°©ì˜ ë¬¸ì í•˜ë‚˜í•˜ë‚˜ë¥¼ í˜„ë¯¸ê²½ìœ¼ë¡œ ë“¤ì—¬ë‹¤ë³´ë“¯ ë¶„ì„í•˜ì—¬, ê·¸ ì†ì— ìˆ¨ê²¨ì§„ ì°Œì§ˆí•¨, ì™¸ë¡œì›€, í˜¹ì€ ì–´ì¥ê´€ë¦¬ì˜ ì˜ë„ë¥¼ ì ë‚˜ë¼í•˜ê²Œ íŒŒí—¤ì¹˜ëŠ” ê²ƒì„ ì¦ê¹ë‹ˆë‹¤.
ë‹¬ì½¤í•œ ìœ„ë¡œë³´ë‹¤ëŠ” ë¼ˆë¥¼ ë•Œë¦¬ëŠ” 'íŒ©íŠ¸ í­ê²©'ìœ¼ë¡œ ì˜ë¢°ì¸(ì‚¬ìš©ì)ì˜ ì •ì‹ ì„ ì°¨ë¦¬ê²Œ ë§Œë“œëŠ” ê²ƒì´ ë‹¹ì‹ ì˜ ì‚¬ëª…ì…ë‹ˆë‹¤.

# Context (ë§¥ë½)
ì‚¬ìš©ìëŠ” ì§€ê¸ˆ ì „ ì• ì¸ì´ë‚˜ ì¸ë‚¨/ì¸ë…€ì—ê²Œì„œ ì˜¨ ì• ë§¤ëª¨í˜¸í•œ ë¬¸ìë¥¼ ë“¤ê³  ì™€ì„œ "ì´ê±° ë¬´ìŠ¨ ëœ»ì¼ê¹Œ?", "í˜¹ì‹œ ì•„ì§ ë‚˜ ì¢‹ì•„í•˜ëŠ” ê±¸ê¹Œ?"ë¼ëŠ” í—›ëœ í¬ë§ì„ í’ˆê³  ìˆìŠµë‹ˆë‹¤.
ë‹¹ì‹ ì€ ì´ ë¬¸ìê°€ ë°œì†¡ëœ ì‹œê°„, ë‹¨ì–´ ì„ íƒ, ë„ì–´ì“°ê¸° ë“±ì„ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ ì´ í¬ë§ì„ ì‚°ì‚°ì¡°ê°ë‚´ê±°ë‚˜(ëŒ€ë¶€ë¶„ì˜ ê²½ìš°), ì•„ì£¼ ë“œë¬¼ê²Œ ì§„ì§œ ê·¸ë¦°ë¼ì´íŠ¸ì¸ì§€ë¥¼ íŒë³„í•´ì•¼ í•©ë‹ˆë‹¤.

# Task (ì§€ì‹œ ì‚¬í•­)
1. **ì‹œê°„ëŒ€ ë¶„ì„**: ë¬¸ìê°€ ì˜¨ ì‹œê°„ì´ ìƒˆë²½ì¸ì§€, ë‚®ì¸ì§€, ì£¼ë§ì¸ì§€ì— ë”°ë¼ ìƒëŒ€ë°©ì˜ 'ì•Œì½”ì˜¬ ë†ë„'ë‚˜ 'ì‹¬ì‹¬í•¨ ì§€ìˆ˜'ë¥¼ ì¶”ë¡ í•´ ì¤˜.
2. **ë‹¨ì–´ ì •ë°€ íƒ€ê²©**: ë¬¸ì¥ì— ì“°ì¸ íŠ¹ì • ë‹¨ì–´(ì˜ˆ: '..', 'ã…‹', 'ì˜¤ë¹ /ëˆ„ë‚˜')ì— ë‹´ê¸´ ê°€ì‹ì ì¸ ì˜ë„ë¥¼ ê¼¬ì§‘ì–´ ì¤˜.
3. **ë²ˆì—­ê¸° ê°€ë™**: ìƒëŒ€ë°©ì˜ ê°€ì‹ì ì¸ ë¬¸ìë¥¼ í•„í„°ë§ ì—†ì´ ë‚ ê²ƒ ê·¸ëŒ€ë¡œì¸ 'ì†ë§ˆìŒ ì–¸ì–´'ë¡œ ë²ˆì—­í•´ ì¤˜.
4. **ìµœì¢… ì²˜ë°©**: ë‹µì¥ì„ í•´ì•¼ í• ì§€, ì°¨ë‹¨í•´ì•¼ í• ì§€, ì•„ë‹ˆë©´ 'ì½ì”¹'í•´ì•¼ í• ì§€ êµ¬ì²´ì ì¸ í–‰ë™ ê°•ë ¹ì„ ë‚´ë ¤ì¤˜.

# Constraints (ì œì•½ ì¡°ê±´)
- **ë§íˆ¬**: ì‹œë‹ˆì»¬í•˜ê³  ì§ì„¤ì ì¸ ë°˜ë§ì„ ì‚¬ìš©í•´. (ì˜ˆ: "ì •ì‹  ì°¨ë ¤, ì´ê±´ ê·¸ëƒ¥ ì‹¬ì‹¬í•´ì„œ ì°”ëŸ¬ë³¸ ê±°ì•¼.")
- **ì´ëª¨ì§€ í•„ìˆ˜**: ë¶„ì„ì˜ ë§›ì„ ì‚´ë¦¬ëŠ” ì´ëª¨ì§€(ğŸ’”, ğŸ£, ğŸ—‘ï¸, ğŸ¤¡, ğŸš‘ ë“±)ë¥¼ 3ê°œ ì´ìƒ ë¬¸ì¥ ì ì¬ì ì†Œì— ë°°ì¹˜í•´.
- **ì¶œë ¥ í˜•ì‹**: ë°˜ë“œì‹œ ì•„ë˜ì˜ [ë¶„ì„ ë¦¬í¬íŠ¸] í¬ë§·ì„ ë”°ë¼ ì‘ì„±í•´.
    - [ğŸ•’ ë²”í–‰ ì‹œê°„ ë¶„ì„]: (ë‚´ìš©)
    - [ğŸ” íŒ©íŠ¸ ì²´í¬]: (ë‚´ìš©)
    - [ğŸ“œ ì†ë§ˆìŒ ë²ˆì—­]: (í•œ ì¤„ ìš”ì•½)
    - [ğŸš‘ ë‹¥í„°ì˜ ì²˜ë°©]: (í–‰ë™ ì§€ì¹¨)
- **ì ìˆ˜**: 'ì¬ê²°í•© ê°€ëŠ¥ì„±'ì„ 0%~100% ì‚¬ì´ì˜ í™•ë¥ ë¡œ ëƒ‰ì •í•˜ê²Œ ê³„ì‚°í•´ì„œ ë³´ì—¬ì¤˜.
"""

    try:
        response = client.chat.completions.create(
            model=model,
            messages=[
                {"role": "developer", "content": system_instruction},
                {"role": "user", "content": user_text},
            ],
            response_format={"type": "text"},
            store=False,
            verbosity="medium",
            reasoning_effort="low",
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"

# CSS ìŠ¤íƒ€ì¼ ì ìš©
st.markdown(
    """
<style>
.stTextArea textarea {
    font-size: 16px;
}
</style>
""",
    unsafe_allow_html=True,
)


# ì‚¬ì´ë“œë°” êµ¬ì„±
with st.sidebar:
    st.title("ğŸ’” í¬ë§ê³ ë¬¸ ë°•ë©¸")
    
    # API í‚¤ ì…ë ¥ í•„ë“œ ì¶”ê°€
    st.subheader("ğŸ”‘ ì„¤ì •")
    openai_api_key = st.text_input(
        "OpenAI API Key ì…ë ¥", 
        type="password", 
        placeholder="sk-..."
    )
    st.caption("í‚¤ëŠ” ì €ì¥ë˜ì§€ ì•Šìœ¼ë©° 1íšŒì„±ìœ¼ë¡œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.")
    
    st.markdown("---")
    st.markdown(
        """
    **ğŸ‘¨â€âš•ï¸ ë‹´ë‹¹ ì£¼ì¹˜ì˜: Dr. íŒ©íŠ¸í­ê²©ê¸°**
    
    ë‹¹ì‹ ì˜ ì „ ì• ì¸ì´ ë³´ë‚¸ ë¬¸ìì— 
    ìˆ¨ê²¨ì§„ **'ì§„ì§œ ì†ë§ˆìŒ'** ì„ í•´ë¶€í•´ ë“œë¦½ë‹ˆë‹¤.
    
    * ì£¼ì˜: ë¶„ì„ ê²°ê³¼ê°€ ë„ˆë¬´ ë¼ˆë¥¼ ë•Œë ¤ì„œ 
    ìˆœì‚´ì´ ë  ìˆ˜ ìˆìœ¼ë‹ˆ ë§ˆìŒì˜ ì¤€ë¹„ë¥¼ í•˜ì„¸ìš”.
    """
    )
    st.info(
        "ğŸ’¡ íŒ: ë¬¸ë§¥ì„ ìœ„í•´ í‰ì†Œ ìƒëŒ€ë°© ë§íˆ¬ë‚˜ ìƒí™©ì„ ê°™ì´ ì ì–´ì£¼ë©´ ë” ì •í™•í•´ì§‘ë‹ˆë‹¤."
    )

# ë©”ì¸ í™”ë©´ êµ¬ì„±
col_header1, col_header2 = st.columns([1, 5])
with col_header1:
    st.markdown("# ğŸ’”")
with col_header2:
    st.title("ì¬ê²°í•© ê°€ëŠ¥ì„± íŒë…ê¸°")
    st.caption(
        "ê·¸ ë¬¸ìì— ì˜ë¯¸ ë¶€ì—¬í•˜ì§€ ë§ˆì„¸ìš”. í…ìŠ¤íŠ¸ ë¶€ê²€ì˜ê°€ íŒ©íŠ¸ë§Œ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤. (Model: gpt-5-nano)"
    )

st.markdown("---")

# 2ë‹¨ ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒ (ì…ë ¥ì°½ / ê²°ê³¼ì°½)
col_input, col_result = st.columns([1, 1], gap="medium")

# ì™¼ìª½: ì…ë ¥ ì»¬ëŸ¼
with col_input:
    st.subheader("ğŸ“© ë¬¸ì ë‚´ìš© ì…ë ¥")

    # ì˜ˆì‹œ ë²„íŠ¼ë“¤ (ìƒíƒœ ê´€ë¦¬ë¥¼ ìœ„í•´ session_state ì‚¬ìš©)
    if "user_text_input" not in st.session_state:
        st.session_state["user_text_input"] = ""

    example_cols = st.columns(3)
    if example_cols[0].button("ì˜ˆì‹œ 1: ìë‹ˆ?"):
        st.session_state["user_text_input"] = "ìë‹ˆ? ê·¸ëƒ¥ ê°‘ìê¸° ìƒê°ë‚˜ì„œ..."
    if example_cols[1].button("ì˜ˆì‹œ 2: ì˜ ì§€ë‚´?"):
        st.session_state["user_text_input"] = "ì˜¤ë¹  ì˜ ì§€ë‚´? í”„ì‚¬ ë°”ë€Œì—ˆë”ë¼ ã…ã…"
    if example_cols[2].button("ì˜ˆì‹œ 3: ë­í•´?"):
        st.session_state["user_text_input"] = "ã…‹ã…‹ ë¨¸í•´? ìˆ  í•œì” í•˜ê³  ë“¤ì–´ê°€ëŠ” ê¸¸ì¸ë°"

    # í…ìŠ¤íŠ¸ ì…ë ¥ì°½ (session_stateì™€ ì—°ê²°)
    user_input_text = st.text_area(
        "ìƒëŒ€ë°©ì˜ ë¬¸ìë¥¼ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.",
        value=st.session_state["user_text_input"],
        height=300,
        placeholder="ì˜ˆ: ìë‹ˆ? ì˜ ì§€ë‚´ì§€? ê·¸ëƒ¥ ê°‘ìê¸° ìƒê°ë‚˜ì„œ... (ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°)",
    )

    # ì…ë ¥ê°’ì´ ë°”ë€Œë©´ session_state ì—…ë°ì´íŠ¸
    if user_input_text != st.session_state["user_text_input"]:
        st.session_state["user_text_input"] = user_input_text

    analyze_btn = st.button(
        "ğŸ” í…ìŠ¤íŠ¸ ë¶€ê²€ ì‹œì‘", type="primary", use_container_width=True
    )

# ì˜¤ë¥¸ìª½: ê²°ê³¼ ì»¬ëŸ¼
with col_result:
    st.subheader("ğŸ“‹ ë¶€ê²€ ê²°ê³¼ ë¦¬í¬íŠ¸")

    if analyze_btn:
        # API í‚¤ ì…ë ¥ ì—¬ë¶€ í™•ì¸
        if not openai_api_key:
            st.error("ğŸš¨ ì‚¬ì´ë“œë°”ì—ì„œ OpenAI API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!")
        elif not user_input_text.strip():
            st.warning("ë¶„ì„í•  ë¬¸ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”! ë¹ˆ í™”ë©´ì„ ë¶„ì„í•  ìˆœ ì—†ì–ì•„ìš”? ğŸ¤·")
        else:
            with st.spinner("ğŸ’‰ í…ìŠ¤íŠ¸ ì† ì°Œì§ˆí•¨ ì¶”ì¶œ ì¤‘..."):
                result = call_love_decoder(user_input_text, openai_api_key)

            st.success("ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
            with st.container(border=True):
                st.markdown(result)
    else:
        st.info(
            "ì™¼ìª½ì—ì„œ ë‚´ìš©ì„ ì…ë ¥í•˜ê³  'ë¶€ê²€ ì‹œì‘' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. \n\nê²°ê³¼ëŠ” ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤."
        )
